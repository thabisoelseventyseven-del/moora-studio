<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin Inbox - Moora Studio</title>
<link rel="stylesheet" href="style.css">
<style>
body { font-family: Arial; margin:0; background:#f5f5f5; color:#111; transition: all 0.3s;}
body.dark-theme { background:#0f0f15; color:#eee; }

.top-left-nav {
    display:flex; justify-content:flex-end; gap:12px; padding:16px 20px; background:inherit; position:sticky; top:0; z-index:1000;
}
.btn { padding:10px 18px; border:none; border-radius:10px; font-weight:600; cursor:pointer; background: linear-gradient(135deg,#50e3c2,#ff6ec7); color:#fff; }
.small-btn { font-size:0.9rem; }

.header { text-align:center; padding:40px 20px 20px; }
.header h1 { font-size:2.4rem; margin-bottom:4px; }
.header p { font-size:1rem; color:#666; }

.admin-container { max-width:1100px; margin:20px auto 60px; padding:0 20px; }

.admin-card { background:#fff; padding:20px; border-radius:14px; margin-bottom:18px; box-shadow:0 5px 12px rgba(0,0,0,0.15);}
body.dark-theme .admin-card { background:#1c1c27; color:#eee; }

.admin-card h3 { margin:0 0 8px 0; }
.admin-card .meta { font-size:0.85rem; color:#888; margin-bottom:10px; }
.admin-card textarea { width:100%; min-height:80px; padding:8px; border-radius:8px; border:1px solid #ccc; margin-bottom:8px; }
body.dark-theme textarea { background:#0f0f15; color:#eee; border:1px solid #333; }

.admin-card button { margin-right:6px; margin-top:6px; padding:6px 12px; border:none; border-radius:8px; cursor:pointer; background:linear-gradient(135deg,#50e3c2,#ff6ec7); color:#fff; font-weight:600; }
.audio-controls { display:flex; flex-wrap:wrap; gap:10px; margin-top:6px; }
audio { width:100%; max-width:300px; }
</style>
</head>
<body>

<div class="top-left-nav">
  <button id="themeToggle" class="btn small-btn">üåô</button>
  <button id="logoutBtn" class="btn small-btn">Logout</button>
</div>

<header class="header">
<h1>Admin Inbox</h1>
<p>Reply to user messages by text or voice. Replies go directly to user inbox.</p>
</header>

<main class="admin-container" id="messagesContainer"></main>

<script>
/* --- Admin Setup --- */
let admin = JSON.parse(sessionStorage.getItem('admin'));
if(!admin){ admin={name:"Admin",email:"admin@moora.local"}; sessionStorage.setItem('admin',JSON.stringify(admin)); }

function jsonGet(key,def=[]){ try{return JSON.parse(localStorage.getItem(key)||'null')||def}catch(e){return def} }
function jsonSet(key,val){ localStorage.setItem(key,JSON.stringify(val)) }

/* --- Render Messages --- */
const messagesContainer = document.getElementById('messagesContainer');

function renderMessages(){
    const inbox = jsonGet('inbox',[]);
    messagesContainer.innerHTML='';
    if(inbox.length===0){ messagesContainer.innerHTML='<p>No messages.</p>'; return; }

    inbox.forEach((msg,index)=>{
        const card = document.createElement('div');
        card.className='admin-card';
        const status = (msg.replyText || msg.adminVoice) ? 'Replied' : 'Pending';

        card.innerHTML=`
        <h3>${msg.userName} (${msg.userEmail}) <small>${status}</small></h3>
        <div class="meta">Templates: ${msg.templates.join(' | ')} ‚Ä¢ Sent: ${new Date(msg.sentAt).toLocaleString()}</div>
        <div><strong>User Message:</strong> <p>${msg.message}</p></div>
        ${msg.userVoice?`<div class="audio-controls"><strong>User Voice:</strong><audio controls src="${msg.userVoice}"></audio></div>`:''}
        <textarea id="replyText-${index}" placeholder="Write reply...">${msg.replyText||''}</textarea>
        <div class="audio-controls">
            <button id="record-${index}">üé§ Record Reply</button>
            <button id="stop-${index}" disabled>‚èπ Stop</button>
            ${msg.adminVoice?`<audio controls src="${msg.adminVoice}"></audio>`:''}
        </div>
        <button onclick="sendReply(${index})">Send Reply</button>
        `;
        messagesContainer.appendChild(card);

        setupRecorder(index);
    });
}

/* --- Admin Voice Recording --- */
function setupRecorder(index){
    const recBtn = document.getElementById(`record-${index}`);
    const stopBtn = document.getElementById(`stop-${index}`);
    if(!recBtn||!stopBtn) return;

    let recorder=null; let chunks=[];
    recBtn.onclick = async ()=>{
        if(!navigator.mediaDevices?.getUserMedia){ alert('Recording not supported'); return; }
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        recorder = new MediaRecorder(stream);
        chunks=[];
        recorder.ondataavailable = e=>chunks.push(e.data);
        recorder.onstop = ()=>{
            const blob = new Blob(chunks,{type:'audio/webm'});
            const reader = new FileReader();
            reader.onloadend = ()=>{
                const inbox = jsonGet('inbox',[]);
                inbox[index].adminVoice = reader.result;
                inbox[index].replyRead = false;
                jsonSet('inbox',inbox);
                renderMessages();
            };
            reader.readAsDataURL(blob);
        };
        recorder.start();
        recBtn.disabled=true; stopBtn.disabled=false;
    };
    stopBtn.onclick = ()=>{
        if(recorder) recorder.stop();
        recBtn.disabled=false; stopBtn.disabled=true;
    };
}

/* --- Send reply --- */
function sendReply(index){
    const inbox = jsonGet('inbox',[]);
    const text = document.getElementById(`replyText-${index}`).value.trim();
    if(!text && !inbox[index].adminVoice){ alert('Add reply text or voice'); return; }
    inbox[index].replyText = text||null;
    inbox[index].repliedAt = new Date().toISOString();
    inbox[index].replyRead = false;
    jsonSet('inbox',inbox);
    alert('Reply sent to user!');
    renderMessages();
}

/* --- Theme & Logout --- */
const themeToggle = document.getElementById('themeToggle');
themeToggle.onclick = ()=>{ document.body.classList.toggle('dark-theme'); localStorage.setItem('theme', document.body.classList.contains('dark-theme')?'dark':'light'); themeToggle.textContent = document.body.classList.contains('dark-theme')?'‚òÄÔ∏è':'üåô'; }
const savedTheme = localStorage.getItem('theme')||'light';
if(savedTheme==='dark'){ document.body.classList.add('dark-theme'); themeToggle.textContent='‚òÄÔ∏è'; } else { themeToggle.textContent='üåô'; }

document.getElementById('logoutBtn').onclick = ()=>{
    sessionStorage.removeItem('admin'); window.location.href='login.html';
};

renderMessages();
</script>

</body>
</html>
