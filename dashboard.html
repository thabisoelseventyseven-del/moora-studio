<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Moora Studio</title>
<link rel="stylesheet" href="style.css">
<style>
/* Dashboard Specific Styles */
.dashboard-container { max-width:1100px; margin:2em auto; padding:0 20px; }
.dashboard-section { margin-bottom:2em; }
.dashboard-cards { display:flex; flex-wrap:wrap; gap:16px; margin-top:1em; }
.dashboard-card { background: #1c1c27; border-radius:12px; padding:1em; flex:1 1 200px; cursor:pointer; color:#fff; text-align:center; }
.dashboard-card.selected-template { border:2px solid #ff6ec7; background:#29293f; }
.template-price { margin-top:6px; font-size:0.95rem; color:#ffd6f0; }

/* Message Box */
#messageBox { width:100%; min-height:100px; padding:10px; border-radius:10px; border:1px solid #333; background:#0f0f15; color:#eee; resize:vertical; font-size:1rem; }
#guidanceMsg { margin:0.5em 0 1em 0; font-size:1rem; color:#ff6ec7; }

/* Voice note controls */
.voice-container { margin-top:0.5em; display:flex; align-items:center; gap:10px; }
.voice-container button { padding:6px 12px; background:#ff4d4d; border:none; color:#fff; border-radius:6px; cursor:pointer; font-size:0.8rem; }
.voice-container audio { width:100%; margin-top:6px; height:40px; }

.send-btn { margin-top:8px; padding:8px 16px; background:linear-gradient(135deg,#50e3c2,#ff6ec7); border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer; }

#inboxContainer { margin-top:1em; }

.inbox-card { background:#29293f; padding:10px; border-radius:10px; margin-bottom:10px; }
.inbox-card textarea { width:100%; min-height:60px; border-radius:6px; padding:6px; margin-top:4px; background:#1c1c27; border:1px solid #333; color:#fff; resize:vertical; }
.inbox-card button { margin-top:4px; margin-right:4px; padding:4px 8px; border:none; border-radius:6px; cursor:pointer; }

@media (max-width:720px){ .dashboard-cards { flex-direction:column; } }
</style>
</head>
<body>

<!-- Floating Dots -->
<div class="floating-dots"><span></span><span></span><span></span><span></span><span></span></div>

<!-- Top Navigation -->
<div class="top-left-nav">
    <a href="dashboard.html" class="btn small-btn">Dashboard</a>
    <a href="inbox.html" class="btn small-btn">Inbox</a>
    <button id="logoutBtn" class="btn small-btn">Logout</button>
    <button id="theme-toggle" class="btn small-btn">‚òÄÔ∏è</button>
</div>

<header class="header">
    <h1>Welcome, <span id="userName"></span></h1>
    <p class="tagline">Select templates and send messages</p>
</header>

<section class="dashboard-container">

    <!-- Templates Section -->
    <div class="dashboard-section">
        <h2>Available Templates</h2>
        <p>Select any template(s) (multiple allowed, no duplicates):</p>
        <div class="dashboard-cards" id="templatesContainer"></div>
    </div>

    <!-- Message / Voice Section -->
    <div class="dashboard-section">
        <h2>Your Message</h2>
        <p id="guidanceMsg">Write your message below. You can also record a voice note.</p>
        <div class="dashboard-card">
            <h3 id="currentTemplate">No template selected</h3>
            <textarea id="messageBox" placeholder="Write your message here..."></textarea>

            <!-- Voice record controls -->
            <div class="voice-container">
                <button id="recordBtn">Record</button>
                <button id="stopBtn" disabled>Stop</button>
                <button id="deleteVoiceBtn">Delete Voice Note</button>
                <audio id="audioPreview" controls style="display:none;"></audio>
            </div>

            <button class="send-btn" id="sendMessageBtn">Send Message</button>
        </div>
    </div>

    <!-- Inbox Section -->
    <div class="dashboard-section">
        <h2>Your Inbox</h2>
        <div id="inboxContainer"></div>
    </div>

</section>

<footer class="footer">
    <p><strong>Contact Us</strong></p>
    <p>üìõ Name: Thabiso Mosesi</p>
    <p>üìû Phone: 072 176 9099</p>
    <p>‚úâÔ∏è Email: thabisoelseventyseven@gmail.com</p>
    <div class="social-icons">
        <a href="#">üìò</a>
        <a href="#">üê¶</a>
        <a href="#">üì∏</a>
        <a href="#">üí¨</a>
    </div>
    <p class="copyright">¬© 2025 Moora Studio</p>
</footer>

<script>
// --- Theme ---
const themeToggle = document.getElementById("theme-toggle");
const savedTheme = localStorage.getItem("theme") || "dark";
if(savedTheme==="light"){ document.body.classList.add("light-theme"); themeToggle.textContent="üåô"; } 
else { themeToggle.textContent="‚òÄÔ∏è"; }
themeToggle.addEventListener("click", ()=>{
    document.body.classList.toggle("light-theme");
    if(document.body.classList.contains("light-theme")){ themeToggle.textContent="üåô"; localStorage.setItem("theme","light"); }
    else { themeToggle.textContent="‚òÄÔ∏è"; localStorage.setItem("theme","dark"); }
});

// --- Logout ---
document.getElementById("logoutBtn").addEventListener("click",()=>{
    sessionStorage.clear();
    window.location.href="login.html";
});

// --- User ---
const user = JSON.parse(sessionStorage.getItem("user"));
if(!user) window.location.href="login.html";
else document.getElementById("userName").textContent=user.name||"User";

// --- Templates ---
let templates = [
    {name:"Business Templates", icon:"üíº"},
    {name:"Portfolio Templates", icon:"üé®"},
    {name:"Landing Pages", icon:"üåê"},
    {name:"Marketing Materials", icon:"üì£"},
    {name:"CV Creation", icon:"üìù"},
    {name:"University Application", icon:"üéì"},
    {name:"Report Templates", icon:"üìä"},
    {name:"Web Templates", icon:"üíª"}
];
let selectedTemplates = [];
const templatesContainer = document.getElementById("templatesContainer");
const currentTemplate = document.getElementById("currentTemplate");
function renderTemplates(){
    templatesContainer.innerHTML="";
    templates.forEach((tpl)=>{
        const div=document.createElement("div");
        div.className="dashboard-card";
        div.innerHTML=`<h3 style="font-size:2rem">${tpl.icon} ${tpl.name}</h3>`;
        div.addEventListener("click",()=>{
            if(selectedTemplates.includes(tpl.name)){ alert("Already selected."); return; }
            selectedTemplates.push(tpl.name);
            div.classList.add("selected-template");
            currentTemplate.textContent = selectedTemplates.join(" | ");
        });
        templatesContainer.appendChild(div);
    });
}
renderTemplates();

// --- Voice Recorder ---
let mediaRecorder, audioChunks=[], audioURL;
const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const deleteVoiceBtn = document.getElementById("deleteVoiceBtn");
const audioPreview = document.getElementById("audioPreview");

recordBtn.addEventListener("click", async ()=>{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();
    recordBtn.disabled=true; stopBtn.disabled=false;
    audioChunks=[];
    mediaRecorder.addEventListener("dataavailable", e=> audioChunks.push(e.data));
    mediaRecorder.addEventListener("stop", ()=>{
        const blob = new Blob(audioChunks,{type:'audio/webm'});
        audioURL = URL.createObjectURL(blob);
        audioPreview.src = audioURL;
        audioPreview.style.display='block';
    });
});

stopBtn.addEventListener("click", ()=>{
    mediaRecorder.stop();
    recordBtn.disabled=false; stopBtn.disabled=true;
});

deleteVoiceBtn.addEventListener("click", ()=>{
    audioURL=null;
    audioPreview.src="";
    audioPreview.style.display="none";
});

// --- Inbox / Send Message ---
const messageBox=document.getElementById("messageBox");
const sendMessageBtn=document.getElementById("sendMessageBtn");
const inboxContainer=document.getElementById("inboxContainer");

function renderInbox(){
    const inbox = JSON.parse(localStorage.getItem("inbox")||'[]').filter(m=>m.email===user.email);
    inboxContainer.innerHTML="";
    if(inbox.length===0){ inboxContainer.innerHTML="<p>No messages yet.</p>"; return; }
    inbox.forEach((m,i)=>{
        const div=document.createElement("div");
        div.className="inbox-card";
        div.innerHTML=`
            <p><strong>Status:</strong> ${m.reply?'Replied':'Pending'}</p>
            <p><strong>Templates:</strong> ${m.templates.join(" | ")}</p>
            ${m.message? `<p>${m.message}</p>`:``}
            ${m.voice? `<audio controls src="${m.voice}"></audio>`:``}
            <textarea id="edit-${i}">${m.message||''}</textarea>
            <button onclick="updateMessage(${i})">Update</button>
            <button onclick="deleteMessage(${i})">Delete</button>
        `;
        inboxContainer.appendChild(div);
    });
}

function updateMessage(idx){
    const inbox = JSON.parse(localStorage.getItem("inbox")||'[]');
    const filtered = inbox.filter(m=>m.email===user.email);
    const msgIndex = inbox.indexOf(filtered[idx]);
    inbox[msgIndex].message = document.getElementById(`edit-${idx}`).value.trim();
    localStorage.setItem('inbox',JSON.stringify(inbox));
    renderInbox();
}

function deleteMessage(idx){
    const inbox = JSON.parse(localStorage.getItem("inbox")||'[]');
    const filtered = inbox.filter(m=>m.email===user.email);
    const msgIndex = inbox.indexOf(filtered[idx]);
    inbox.splice(msgIndex,1);
    localStorage.setItem('inbox',JSON.stringify(inbox));
    renderInbox();
}

sendMessageBtn.addEventListener('click', ()=>{
    const text = messageBox.value.trim();
    if(selectedTemplates.length===0){ alert("Select at least one template."); return; }
    if(!text && !audioURL){ alert("Message or voice required."); return; }

    const inbox = JSON.parse(localStorage.getItem("inbox")||'[]');
    inbox.push({
        user: user.name,
        email: user.email,
        templates: [...selectedTemplates],
        message: text||null,
        voice: audioURL||null,
        reply: null,
        adminVoice: null,
        sentAt: new Date().toISOString()
    });
    localStorage.setItem('inbox',JSON.stringify(inbox));

    alert("Message sent!");
    messageBox.value="";
    audioURL=null;
    audioPreview.src=""; audioPreview.style.display="none";
    selectedTemplates=[];
    currentTemplate.textContent="No template selected";
    renderTemplates();
    renderInbox();
});

renderInbox();
</script>

</body>
</html>
