<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard - Moora Studio</title>
<link rel="stylesheet" href="style.css">
<style>
/* ---------- Global Styles ---------- */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f5f5f5;
    color: #111;
    transition: background 0.3s, color 0.3s;
}
body.dark-theme {
    background: #0f0f15;
    color: #eee;
}

/* ---------- Top Nav ---------- */
.top-left-nav {
    display: flex;
    gap: 12px;
    padding: 12px 20px;
    align-items: center;
}
.btn {
    background: linear-gradient(135deg,#50e3c2,#ff6ec7);
    color: #fff;
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    text-decoration: none;
}
.small-btn { font-size: 0.9rem; }

/* ---------- Header ---------- */
.header {
    text-align: center;
    padding: 24px 10px;
}
.header h1 { font-size: 2.4rem; margin: 0; }
.header p { font-size: 1.1rem; color: #666; }

/* ---------- Dashboard Container ---------- */
.dashboard-container {
    max-width: 1100px;
    margin: 16px auto;
    padding: 0 20px 60px;
}

/* ---------- Templates ---------- */
.dashboard-section { margin-bottom: 28px; }
.dashboard-cards {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    margin-top: 12px;
}
.dashboard-card {
    background: #1c1c27;
    border-radius: 14px;
    padding: 18px;
    flex: 1 1 220px;
    text-align: center;
    cursor: pointer;
    color: #fff;
    transition: transform 0.2s;
}
.dashboard-card:hover { transform: scale(1.05); }
.dashboard-card.selected-template {
    border: 3px solid #ff6ec7;
    background: #29293f;
}
.dashboard-card div.icon { font-size: 36px; margin-bottom: 8px; }
.dashboard-card div.name { font-weight: 700; font-size: 1.1rem; }
.dashboard-card .template-price { margin-top: 6px; font-size: 1rem; color: #ffd6f0; }

/* Selected Templates */
#selectedTemplatesDisplay {
    margin-top: 12px;
    font-size: 1.2rem;
    font-weight: 700;
    color: #ff6ec7;
}

/* ---------- Message Box ---------- */
.message-card {
    background: #1a1a28;
    padding: 16px;
    border-radius: 14px;
}
#messageBox {
    width: 100%;
    min-height: 100px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #333;
    background: #f5f5f5;
    color: #111;
    resize: vertical;
}
body.dark-theme #messageBox {
    background: #0f0f15;
    color: #eee;
    border: 1px solid #333;
}

/* Voice Controls */
.voice-controls { display: flex; gap: 12px; margin-top: 12px; }
.voice-controls button { flex: 1; }
audio { width: 100%; margin-top: 10px; }

/* ---------- Inbox ---------- */
.inbox-list { margin-top: 12px; }
.inbox-item {
    background: #29293f;
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 12px;
    color: #fff;
}
.inbox-item p { margin: 6px 0; }

/* Notification Badge */
.badge {
    background: #ff6ec7;
    color: #fff;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 0.85rem;
    margin-left: 6px;
    display: none;
}

/* Footer */
.footer { padding: 22px; text-align: center; color: #666; margin-top: 30px; }

/* Responsive */
@media(max-width:720px){ .dashboard-cards{ flex-direction: column; } }
</style>
</head>
<body>

<!-- Top Nav -->
<div class="top-left-nav">
  <a class="btn small-btn" href="dashboard.html">Dashboard</a>
  <a class="btn small-btn" href="inbox.html">
    Inbox <span id="inboxBadge" class="badge">0</span>
  </a>
  <button id="themeToggle" class="btn small-btn">üåô</button>
  <button id="logoutBtn" class="btn small-btn">Logout</button>
</div>

<header class="header">
  <h1>Welcome, <span id="userName"></span></h1>
  <p>Select templates and send a message to admin (text or voice)</p>
</header>

<main class="dashboard-container">

<!-- Templates -->
<section class="dashboard-section">
  <h2>Choose Templates</h2>
  <div id="templatesContainer" class="dashboard-cards"></div>
  <div id="selectedTemplatesDisplay">Selected: None</div>
</section>

<!-- Message Box -->
<section class="dashboard-section">
  <h2>Your Message</h2>
  <div class="message-card">
    <textarea id="messageBox" placeholder="Write your message (optional if you record)"></textarea>
    <div class="voice-controls">
      <button id="recordBtn" class="btn">üé§ Record</button>
      <button id="stopBtn" class="btn" disabled>‚èπ Stop</button>
      <button id="deleteVoiceBtn" class="btn" style="background:#ff4d4d">Delete Voice</button>
    </div>
    <audio id="userVoicePreview" controls style="display:none"></audio>
    <button id="sendBtn" class="btn" style="margin-top:12px;">Send to Admin</button>
    <div id="statusNote" style="margin-top:10px;color:#50e3c2;font-weight:700;display:none"></div>
  </div>
</section>

<!-- Inbox -->
<section class="dashboard-section">
  <h2>Your Inbox (Admin Replies)</h2>
  <div id="inboxList" class="inbox-list"></div>
</section>

</main>

<footer class="footer">
¬© 2025 Moora Studio ‚Äî contact: thabisoelseventyseven@gmail.com
</footer>

<script>
// ---------- User & Theme ----------
let user = JSON.parse(sessionStorage.getItem('user'));
if(!user){ user={name:"Demo User",email:"demo@example.com"}; sessionStorage.setItem('user', JSON.stringify(user)); }
document.getElementById('userName').textContent = user.name;

// Default light mode
document.body.classList.remove('dark-theme');
document.getElementById('themeToggle').textContent = 'üåô';

// Theme toggle
document.getElementById('themeToggle').addEventListener('click', ()=>{
    document.body.classList.toggle('dark-theme');
    document.getElementById('themeToggle').textContent = document.body.classList.contains('dark-theme') ? '‚òÄÔ∏è' : 'üåô';
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', ()=>{
    sessionStorage.removeItem('user');
    window.location.href='login.html';
});

// ---------- Storage Helpers ----------
function jsonGet(key, defaultVal){ try { return JSON.parse(localStorage.getItem(key)||'null') || defaultVal; } catch(e){ return defaultVal; } }
function jsonSet(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

// ---------- Templates ----------
const templates = [
  { name:"Business Templates", price:"R250", icon:"üíº" },
  { name:"Portfolio Templates", price:"R200", icon:"üé®" },
  { name:"Landing Pages", price:"R300", icon:"üåê" },
  { name:"Marketing Materials", price:"R180", icon:"üì£" },
  { name:"CV Creation", price:"R100", icon:"üìù" },
  { name:"University Application", price:"R150", icon:"üéì" },
  { name:"Report Templates", price:"R120", icon:"üìä" },
  { name:"Web Templates", price:"R350", icon:"üíª" }
];

let selectedTemplates = [];
const templatesContainer = document.getElementById('templatesContainer');
const selectedDisplay = document.getElementById('selectedTemplatesDisplay');

templates.forEach(t=>{
  const el = document.createElement('div');
  el.className='dashboard-card';
  el.innerHTML=`<div class="icon">${t.icon}</div><div class="name">${t.name}</div><div class="template-price">${t.price}</div>`;
  el.addEventListener('click', ()=>{
    if(!selectedTemplates.includes(t.name)){
      selectedTemplates.push(t.name);
      el.classList.add('selected-template');
      selectedDisplay.innerHTML = 'Selected: ' + selectedTemplates.map(n=>{
        const temp = templates.find(tt=>tt.name===n);
        return temp.icon+' '+temp.name;
      }).join(' | ');
    }
  });
  templatesContainer.appendChild(el);
});

// ---------- Voice Recording ----------
let mediaRecorder=null, audioChunks=[], userVoiceDataUrl=null;
const recordBtn=document.getElementById('recordBtn');
const stopBtn=document.getElementById('stopBtn');
const deleteVoiceBtn=document.getElementById('deleteVoiceBtn');
const userVoicePreview=document.getElementById('userVoicePreview');

recordBtn.addEventListener('click', async ()=>{
  if(!navigator.mediaDevices?.getUserMedia){ alert('Recording not supported'); return; }
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks=[];
  mediaRecorder.addEventListener('dataavailable', e=>audioChunks.push(e.data));
  mediaRecorder.addEventListener('stop', ()=>{
    const blob = new Blob(audioChunks,{type:'audio/webm'});
    const reader = new FileReader();
    reader.onloadend = ()=> {
      userVoiceDataUrl = reader.result;
      userVoicePreview.src=userVoiceDataUrl;
      userVoicePreview.style.display='block';
    };
    reader.readAsDataURL(blob);
  });
  mediaRecorder.start();
  recordBtn.disabled=true; stopBtn.disabled=false;
});

stopBtn.addEventListener('click', ()=>{
  if(mediaRecorder) mediaRecorder.stop();
  recordBtn.disabled=false; stopBtn.disabled=true;
});

deleteVoiceBtn.addEventListener('click', ()=>{
  userVoiceDataUrl=null;
  userVoicePreview.src=''; userVoicePreview.style.display='none';
});

// ---------- Send Message ----------
const sendBtn=document.getElementById('sendBtn');
const messageBox=document.getElementById('messageBox');
const statusNote=document.getElementById('statusNote');
sendBtn.addEventListener('click', ()=>{
  const text = messageBox.value.trim();
  if(selectedTemplates.length===0){ alert('Select at least one template'); return; }
  if(!text && !userVoiceDataUrl){ alert('Add message text or record a voice note'); return; }

  const inbox=jsonGet('inbox',[]);
  inbox.push({
    id:'m_'+Date.now(),
    userName:user.name,
    userEmail:user.email,
    templates:selectedTemplates.slice(),
    message:text || null,
    userVoice:userVoiceDataUrl || null,
    replyText:null,
    adminVoice:null,
    repliedAt:null,
    replyRead:false,
    sentAt:new Date().toISOString()
  });
  jsonSet('inbox',inbox);

  messageBox.value=''; userVoiceDataUrl=null; userVoicePreview.src=''; userVoicePreview.style.display='none';
  selectedTemplates=[]; selectedDisplay.textContent='Selected: None';
  document.querySelectorAll('.dashboard-card.selected-template').forEach(e=>e.classList.remove('selected-template'));

  statusNote.style.display='block'; statusNote.textContent='Message sent to admin';
  setTimeout(()=>statusNote.style.display='none',2000);

  renderUserInbox();
});

// ---------- User Inbox ----------
const inboxList=document.getElementById('inboxList');
const inboxBadge=document.getElementById('inboxBadge');

function renderUserInbox(){
  const inbox=jsonGet('inbox',[]);
  const replies=inbox.filter(it=>it.userEmail===user.email && (it.replyText || it.adminVoice));
  inboxList.innerHTML = '';
  if(replies.length===0){ inboxList.innerHTML='<p>No replies from admin yet.</p>'; }
  replies.forEach((it,idx)=>{
    const item=document.createElement('div');
    item.className='inbox-item';
    item.innerHTML=`<p><strong>From Admin:</strong> ${it.repliedAt? ' ‚Ä¢ '+new Date(it.repliedAt).toLocaleString() : ''}</p>
                    ${it.replyText? `<p>${it.replyText}</p>` : ''}
                    ${it.adminVoice? `<audio controls src="${it.adminVoice}"></audio>`: '' }
                    <div style="margin-top:6px;font-size:0.9rem;color:#aaa">Templates: ${it.templates.join(' | ')}</div>`;
    inboxList.appendChild(item);
    if(!it.replyRead) it.replyRead=true;
  });
  jsonSet('inbox',inbox);
  updateBadge();
}

function updateBadge(){
  const inbox=jsonGet('inbox',[]);
  const unread=inbox.filter(it=>it.userEmail===user.email && (it.replyText || it.adminVoice) && !it.replyRead).length;
  if(unread>0){ inboxBadge.style.display='inline-block'; inboxBadge.textContent=unread; }
  else{ inboxBadge.style.display='none'; }
}

renderUserInbox();
</script>
</body>
</html>
