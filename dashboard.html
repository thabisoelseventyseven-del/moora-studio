<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard - Moora Studio</title>
<link rel="stylesheet" href="style.css">
<style>
/* Minimal necessary styles (keeps your look) */
body { font-family: Arial, sans-serif; background:#0f0f15; color:#eee; margin:0; }
.top-left-nav { display:flex; gap:12px; padding:12px 20px; align-items:center; }
.btn { background:linear-gradient(135deg,#50e3c2,#ff6ec7); color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; border:none; cursor:pointer; }
.small-btn { padding:6px 10px; font-size:0.9rem; }
.header { text-align:center; padding:18px 10px; }
.dashboard-container { max-width:1100px; margin:16px auto; padding:0 20px 60px; }
.dashboard-section { margin-bottom:22px; }
.dashboard-cards { display:flex; flex-wrap:wrap; gap:14px; margin-top:12px; }
.dashboard-card { background:#1c1c27; border-radius:12px; padding:14px; flex:1 1 220px; cursor:pointer; color:#fff; text-align:center; }
.dashboard-card.selected-template { border:2px solid #ff6ec7; background:#29293f; }
.template-price { margin-top:8px; font-size:0.95rem; color:#ffd6f0; }

/* Message area */
.message-card { background:#1a1a28; padding:16px; border-radius:12px; }
#messageBox { width:100%; min-height:100px; padding:12px; border-radius:8px; background:#0f0f15; border:1px solid #333; color:#eee; resize:vertical; }
.voice-controls { display:flex; gap:8px; align-items:center; margin-top:10px; }
.voice-controls button { padding:8px 10px; border-radius:8px; border:none; cursor:pointer; }
audio { width:100%; margin-top:8px; }

/* Inbox (user sees only admin replies) */
.inbox-list { margin-top:8px; }
.inbox-item { background:#29293f; padding:12px; border-radius:10px; margin-bottom:10px; color:#fff; }
.inbox-item p { margin:6px 0; }

/* Badge style (A: next to Inbox link) */
.badge { background:#ff6ec7; color:#fff; border-radius:999px; padding:2px 8px; font-size:0.85rem; margin-left:6px; display:none; }

.footer { padding:22px; text-align:center; color:#ddd; margin-top:30px; }

/* Responsive */
@media (max-width:720px){ .dashboard-cards{ flex-direction:column; } }
</style>
</head>
<body>

<!-- Top navigation with Inbox badge (A) -->
<div class="top-left-nav">
  <a class="btn small-btn" href="dashboard.html">Dashboard</a>
  <a class="btn small-btn" href="inbox.html" id="inboxLink">Inbox <span id="inboxBadge" class="badge">0</span></a>
  <button id="logoutBtn" class="btn small-btn">Logout</button>
  <button id="themeToggle" class="btn small-btn">‚òÄÔ∏è</button>
</div>

<header class="header">
  <h1>Welcome, <span id="userName">User</span></h1>
  <p class="tagline">Select templates and send a message to admin (text or voice)</p>
</header>

<main class="dashboard-container">

  <!-- Templates (user selects templates) -->
  <section class="dashboard-section">
    <h2>Choose Templates</h2>
    <div id="templatesContainer" class="dashboard-cards"></div>
  </section>

  <!-- Message box: user writes or records and sends -->
  <section class="dashboard-section">
    <h2>Your Message</h2>
    <div class="message-card">
      <div id="selectedTemplates" style="margin-bottom:8px;color:#ffd6f0;font-weight:600">Selected: <span id="currentTemplates">None</span></div>
      <textarea id="messageBox" placeholder="Write your message here (optional if you record)"></textarea>

      <div class="voice-controls">
        <button id="recordBtn" class="btn">üé§ Record</button>
        <button id="stopBtn" class="btn" disabled>‚èπ Stop</button>
        <button id="deleteVoiceBtn" class="btn" style="background:#ff4d4d">Delete Voice</button>
      </div>
      <audio id="userVoicePreview" controls style="display:none"></audio>

      <div style="margin-top:12px">
        <button id="sendBtn" class="btn">Send to Admin</button>
      </div>

      <div id="statusNote" style="margin-top:10px;color:#50e3c2;font-weight:700;display:none"></div>
    </div>
  </section>

  <!-- Inbox: IMPORTANT ‚Äî user inbox shows ONLY admin replies -->
  <section class="dashboard-section">
    <h2>Your Inbox (admin replies)</h2>
    <div id="inboxList" class="inbox-list">
      <!-- populated by JS: only messages that have admin reply -->
    </div>
  </section>

</main>

<footer class="footer">
  ¬© 2025 Moora Studio ‚Äî contact: thabisoelseventyseven@gmail.com
</footer>

<script>
/* -------------------------
  Simple client-only messaging system
  - user sends message -> stored in localStorage as inboxEntry
  - admin sees messages in admin.html and replies
  - user inbox shows only admin replies (reply text and/or adminVoice)
  - badge shows unread replies count (A-style next to Inbox)
--------------------------*/

/* Helper: safe JSON get */
function jsonGet(key, defaultVal){ try { return JSON.parse(localStorage.getItem(key)||'null') || defaultVal; } catch(e){ return defaultVal; } }
function jsonSet(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

/* Identity: store a 'user' object in sessionStorage on login flow; fallback to demo user if missing */
let user = null;
try {
  user = JSON.parse(sessionStorage.getItem('user'));
} catch(e){}
if(!user){
  // Demo fallback (if you have an actual login page, set sessionStorage user there)
  user = { name: "Demo User", email: "demo@example.com" };
  sessionStorage.setItem('user', JSON.stringify(user));
}
document.getElementById('userName').textContent = user.name;

/* Templates data (kept minimal) */
const templates = [
  { name: "Business Templates", price: "R250", icon: "üíº" },
  { name: "Portfolio Templates", price: "R200", icon: "üé®" },
  { name: "Landing Pages", price: "R300", icon: "üåê" },
  { name: "Marketing Materials", price: "R180", icon: "üì£" },
  { name: "CV Creation", price: "R100", icon: "üìù" },
  { name: "University Application", price: "R150", icon: "üéì" },
  { name: "Report Templates", price: "R120", icon: "üìä" },
  { name: "Web Templates", price: "R350", icon: "üíª" }
];

/* Render templates and selection */
const templatesContainer = document.getElementById('templatesContainer');
const currentTemplatesEl = document.getElementById('currentTemplates');
let selectedTemplates = [];

function renderTemplates(){
  templatesContainer.innerHTML = '';
  templates.forEach(t=>{
    const el = document.createElement('div');
    el.className = 'dashboard-card';
    el.innerHTML = `<div style="font-size:28px">${t.icon}</div><div style="font-weight:700">${t.name}</div><div class="template-price">${t.price}</div>`;
    el.addEventListener('click', ()=>{
      if(selectedTemplates.includes(t.name)) return;
      selectedTemplates.push(t.name);
      el.classList.add('selected-template');
      currentTemplatesEl.textContent = selectedTemplates.join(' | ');
    });
    templatesContainer.appendChild(el);
  });
}
renderTemplates();

/* Voice recording for user */
let mediaRecorder = null;
let audioChunks = [];
let userVoiceDataUrl = null;
const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const deleteVoiceBtn = document.getElementById('deleteVoiceBtn');
const userVoicePreview = document.getElementById('userVoicePreview');

recordBtn.addEventListener('click', async ()=>{
  if(!navigator.mediaDevices?.getUserMedia){ alert('Recording not supported in this browser'); return; }
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  mediaRecorder.addEventListener('dataavailable', e => audioChunks.push(e.data));
  mediaRecorder.addEventListener('stop', ()=>{
    const blob = new Blob(audioChunks, { type: 'audio/webm' });
    const reader = new FileReader();
    reader.onloadend = ()=> {
      userVoiceDataUrl = reader.result;            // base64 data url
      userVoicePreview.src = userVoiceDataUrl;
      userVoicePreview.style.display = 'block';
    };
    reader.readAsDataURL(blob);
  });
  mediaRecorder.start();
  recordBtn.disabled = true;
  stopBtn.disabled = false;
});

stopBtn.addEventListener('click', ()=>{
  if(mediaRecorder) mediaRecorder.stop();
  recordBtn.disabled = false;
  stopBtn.disabled = true;
});

deleteVoiceBtn.addEventListener('click', ()=>{
  userVoiceDataUrl = null;
  userVoicePreview.src = '';
  userVoicePreview.style.display = 'none';
});

/* Send message to admin (message DOES NOT appear in user inbox) */
const sendBtn = document.getElementById('sendBtn');
const messageBox = document.getElementById('messageBox');
const statusNote = document.getElementById('statusNote');

sendBtn.addEventListener('click', ()=>{
  const text = messageBox.value.trim();

  if(selectedTemplates.length === 0){
    alert('Please select at least one template.');
    return;
  }
  if(!text && !userVoiceDataUrl){
    alert('Please add a message text or record a voice note.');
    return;
  }

  // inbox array is used for all messages (serverless simulation)
  const inbox = jsonGet('inbox', []);
  // push message object (note: "reply" is admin's reply; user inbox should show only replies)
  inbox.push({
    id: 'm_'+Date.now(),
    userName: user.name,
    userEmail: user.email,
    templates: selectedTemplates.slice(),
    message: text || null,
    userVoice: userVoiceDataUrl || null,
    replyText: null,
    adminVoice: null,
    repliedAt: null,
    replyRead: false,     // unread by user when admin replies
    sentAt: new Date().toISOString()
  });
  jsonSet('inbox', inbox);

  // clear UI message box and selections
  messageBox.value = '';
  userVoiceDataUrl = null;
  userVoicePreview.src = '';
  userVoicePreview.style.display = 'none';
  selectedTemplates = [];
  currentTemplatesEl.textContent = 'None';
  // remove selected styles from template tiles
  document.querySelectorAll('.dashboard-card.selected-template').forEach(el=>el.classList.remove('selected-template'));

  // notify
  statusNote.style.display = 'block';
  statusNote.textContent = 'Message sent to admin.';
  setTimeout(()=> statusNote.style.display = 'none', 2500);

  // admin may have a separate UI; just update badge (no replies yet)
  updateBadge(); // not strictly necessary (no replies), but keeps state consistent
});

/* ---------------------------
  User Inbox (shows only admin replies)
   - show entries where replyText or adminVoice is present
   - mark replyRead true when displayed (so badge clears)
----------------------------*/

const inboxList = document.getElementById('inboxList');
const inboxBadge = document.getElementById('inboxBadge');

function renderUserInbox(){
  const inbox = jsonGet('inbox', []);
  // only entries for this user that have an admin reply (text or voice)
  const replies = inbox.filter(it => it.userEmail === user.email && (it.replyText || it.adminVoice));
  inboxList.innerHTML = '';
  if(replies.length === 0){
    inboxList.innerHTML = '<p>No replies from admin yet.</p>';
  } else {
    replies.forEach((it, idx) => {
      const item = document.createElement('div');
      item.className = 'inbox-item';
      const repliedAt = it.repliedAt ? new Date(it.repliedAt).toLocaleString() : '';
      item.innerHTML = `
        <p><strong>From:</strong> Admin ${repliedAt ? ' ‚Ä¢ ' + repliedAt : ''}</p>
        ${it.replyText ? `<p>${it.replyText}</p>` : ''}
        ${it.adminVoice ? `<div><strong>Voice reply</strong><br><audio controls src="${it.adminVoice}"></audio></div>` : ''}
        <div style="margin-top:8px;color:#aaa;font-size:0.9rem">Templates: ${it.templates.join(' | ')}</div>
      `;
      inboxList.appendChild(item);
      // mark reply as read (so badge decreases)
      if(it.replyText || it.adminVoice){
        if(!it.replyRead){
          it.replyRead = true;
        }
      }
    });
    // save updated read flags
    jsonSet('inbox', inbox);
  }
  updateBadge();
}

/* badge: count admin replies for this user that are unread */
function updateBadge(){
  const inbox = jsonGet('inbox', []);
  const unread = inbox.filter(it => it.userEmail === user.email && (it.replyText || it.adminVoice) && !it.replyRead).length;
  if(unread > 0){
    inboxBadge.style.display = 'inline-block';
    inboxBadge.textContent = String(unread);
  } else {
    inboxBadge.style.display = 'none';
  }
}

/* When user opens dashboard page we render inbox (user only sees admin replies) */
renderUserInbox();
updateBadge();

/* small extras: theme toggle and logout behavior */
document.getElementById('themeToggle').addEventListener('click', ()=>{
  document.body.classList.toggle('light-theme');
});
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  sessionStorage.removeItem('user');
  // keep localStorage data; redirect to login (if exists)
  alert('Logged out (session cleared).');
  window.location.href = 'login.html';
});
</script>
</body>
</html>
