<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel - Moora Studio</title>
<link rel="stylesheet" href="style.css">

<style>
/* Admin panel ‚Äî inline styles to complement style.css */
.admin-header {
  padding: 42px 20px;
  text-align: center;
  background: linear-gradient(135deg,#0d0d12,#1a1a28);
  color: white;
}
.admin-header h1{ margin:0; font-size:2.2rem; }
.admin-container { max-width:1100px; margin:30px auto; padding: 0 20px 60px; }

.admin-controls {
  display:flex;
  gap:10px;
  justify-content:flex-end;
  margin-bottom:16px;
  align-items:center;
}

.admin-card {
  background: linear-gradient(180deg,#11111a,#0f0f15);
  border-radius:12px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 6px 18px rgba(0,0,0,0.35);
  border-left:6px solid #ff6ec7;
  color: #eaeaea;
}

.admin-card h3 { margin:0 0 6px 0; font-size:1.15rem; color:#ffd6f0; }
.meta { font-size:0.9rem; color:#bfc7d1; margin-bottom:8px; }

.message-body { background:#0b0b11; padding:12px; border-radius:8px; color:#ddd; margin-bottom:10px; white-space:pre-wrap; }
.reply-box { margin-top:10px; display:flex; gap:10px; align-items:flex-start; }
.reply-textarea {
  width:100%;
  min-height:88px;
  padding:12px;
  border-radius:8px;
  border:1px solid #333;
  background:#0f0f15;
  color:#eee;
  resize:vertical;
  font-size:0.95rem;
}
.reply-btn { padding:10px 14px; background:linear-gradient(135deg,#50e3c2,#ff6ec7); border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer; }
.del-btn { padding:8px 12px; background:#ff6e6e; border:none; color:white; border-radius:8px; cursor:pointer; }

.status-pill { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:0.79rem; margin-left:10px; }
.pending { background:orange; color:black; }
.replied { background:#66ff99; color:black; }

.empty { text-align:center; color:#c9c9c9; padding:36px; background:#0f1013; border-radius:10px; }

/* responsive */
@media (max-width:720px){
  .admin-controls { justify-content:center; flex-wrap:wrap; }
  .reply-box { flex-direction:column; }
}
</style>
</head>
<body>

<!-- Top nav -->
<div class="top-left-nav" style="position:static;padding:12px 20px;background:transparent;">
  <a href="dashboard.html" class="btn small-btn">Dashboard</a>
  <a href="inbox.html" class="btn small-btn">Inbox</a>
  <button id="theme-toggle" class="btn small-btn">‚òÄÔ∏è</button>
  <button id="logoutBtn" class="btn small-btn" style="margin-left:8px;">Logout</button>
</div>

<header class="admin-header">
  <h1>Admin Panel ‚Äî User Messages</h1>
  <p class="tagline">Reply to user messages. Replies are delivered to each user's inbox.</p>
</header>

<main class="admin-container">
  <div class="admin-controls">
    <input id="searchInput" placeholder="Search by name, email or template..." style="padding:10px;border-radius:8px;border:1px solid #333;background:#11111a;color:#eee;width:320px" />
    <button id="refreshBtn" class="btn">Refresh</button>
    <button id="clearAllBtn" class="btn" title="Delete all messages">Clear All Messages</button>
  </div>

  <section id="messagesList"></section>
</main>

<script>
// Theme toggle (keeps consistent with other pages)
const themeToggle = document.getElementById("theme-toggle");
if(localStorage.getItem('theme') === 'light'){
  document.body.classList.add('light-theme');
  themeToggle.textContent = 'üåô';
} else {
  themeToggle.textContent = '‚òÄÔ∏è';
}
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('light-theme');
  if(document.body.classList.contains('light-theme')) {
    themeToggle.textContent = 'üåô';
    localStorage.setItem('theme','light');
  } else {
    themeToggle.textContent = '‚òÄÔ∏è';
    localStorage.setItem('theme','dark');
  }
});

// Logout button (returns to login)
document.getElementById('logoutBtn').addEventListener('click', () => {
  sessionStorage.clear();
  window.location.href = 'login.html';
});

// Core containers
const messagesList = document.getElementById('messagesList');
const searchInput = document.getElementById('searchInput');
const refreshBtn = document.getElementById('refreshBtn');
const clearAllBtn = document.getElementById('clearAllBtn');

// Load every message from localStorage inbox (this is where user messages go)
function loadAdminMessages(filter = '') {
  // inbox array: stored by dashboard when user sends message
  const inbox = JSON.parse(localStorage.getItem('inbox') || '[]');

  // If no messages at all
  if(!inbox || inbox.length === 0){
    messagesList.innerHTML = `<div class="empty">No user messages found.</div>`;
    return;
  }

  // Optionally filter by search term
  const q = filter.trim().toLowerCase();
  const filtered = q ? inbox.filter(m =>
    (m.user && m.user.toLowerCase().includes(q)) ||
    (m.email && m.email.toLowerCase().includes(q)) ||
    (m.templates && m.templates.join(' | ').toLowerCase().includes(q)) ||
    (m.message && m.message.toLowerCase().includes(q))
  ) : inbox;

  // Build UI
  messagesList.innerHTML = '';
  filtered.forEach((msg, idx) => {
    // Create card
    const card = document.createElement('div');
    card.className = 'admin-card';

    // status
    const statusHTML = msg.reply ? `<span class="status-pill replied">Replied</span>` : `<span class="status-pill pending">Pending</span>`;

    // timestamp when present
    const ts = msg.sentAt ? ` ‚Ä¢ ${new Date(msg.sentAt).toLocaleString()}` : '';

    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
        <div style="flex:1 1 0">
          <h3>${msg.user || 'Unknown user'} <small style="color:#b9c6d6;font-weight:600">(${msg.email || 'no-email'})</small>${statusHTML}</h3>
          <div class="meta">Templates: ${msg.templates ? msg.templates.join(' | ') : '(none)'}${ts}</div>
        </div>
        <div style="text-align:right">
          <button class="del-btn" data-index="${idx}">Delete</button>
        </div>
      </div>

      <div class="message-body"><strong>User message:</strong><br>${escapeHtml(msg.message || '')}</div>

      ${msg.reply ? `
        <div class="reply-box" style="margin-bottom:8px">
          <div style="flex:1">
            <p><strong>Admin reply:</strong></p>
            <p style="color:#cbeff7">${escapeHtml(msg.reply)}</p>
          </div>
        </div>
      ` : ''}

      <div class="reply-box">
        <textarea class="reply-textarea" id="reply-${idx}" placeholder="Write a reply to this user...">${msg.reply ? msg.reply : ''}</textarea>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="reply-btn" data-index="${idx}">Send Reply</button>
          <small style="color:#9aa3b2">Reply will appear in the user's inbox.</small>
        </div>
      </div>
    `;

    messagesList.appendChild(card);
  });

  // wire delete and reply handlers (use event delegation)
  // Delete buttons
  messagesList.querySelectorAll('.del-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const i = parseInt(btn.getAttribute('data-index'));
      deleteMessageByFilteredIndex(i, filtered, inbox);
    });
  });

  // Reply buttons
  messagesList.querySelectorAll('.reply-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const i = parseInt(btn.getAttribute('data-index'));
      const textarea = document.getElementById(`reply-${i}`);
      if(!textarea) return;
      const text = textarea.value.trim();
      if(!text){
        alert('Reply cannot be empty.');
        return;
      }
      sendReplyToInboxMessage(filtered[i], text);
    });
  });
}

// Escape helper for safe rendering
function escapeHtml(str = ''){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;')
    .replaceAll('\n','<br>');
}

// Delete message by finding it in the real inbox array and removing it
function deleteMessageByFilteredIndex(filteredIndex, filteredArray, fullInbox){
  const target = filteredArray[filteredIndex];
  if(!target) return;
  if(!confirm('Delete this user message? This action cannot be undone.')) return;

  // find index in the real inbox
  const idx = fullInbox.findIndex(m =>
    m.email === target.email &&
    m.message === target.message &&
    JSON.stringify(m.templates) === JSON.stringify(target.templates) &&
    (m.sentAt || '') === (target.sentAt || '')
  );
  if(idx > -1) {
    fullInbox.splice(idx,1);
    localStorage.setItem('inbox', JSON.stringify(fullInbox));
    loadAdminMessages(searchInput.value);
    // notify: update inbox badge for users (dashboard reads inbox length)
    alert('Message deleted.');
  } else {
    alert('Could not find message to delete.');
  }
}

// When admin replies: update the inbox entry's .reply and .repliedAt
function sendReplyToInboxMessage(targetMessage, replyText){
  let inbox = JSON.parse(localStorage.getItem('inbox') || '[]');
  // find message index (first match)
  const realIndex = inbox.findIndex(m =>
    m.email === targetMessage.email &&
    m.message === targetMessage.message &&
    JSON.stringify(m.templates) === JSON.stringify(targetMessage.templates) &&
    (m.sentAt || '') === (targetMessage.sentAt || '')
  );

  if(realIndex === -1){
    alert('Message not found (may have been deleted). Refreshing list.');
    loadAdminMessages(searchInput.value);
    return;
  }

  inbox[realIndex].reply = replyText;
  inbox[realIndex].repliedAt = new Date().toISOString();
  localStorage.setItem('inbox', JSON.stringify(inbox));

  alert('Reply saved and will appear in the user inbox.');
  loadAdminMessages(searchInput.value);
  // optional: you could implement a small log or send a notification
}

// Refresh / search handlers
refreshBtn.addEventListener('click', () => loadAdminMessages(searchInput.value));
searchInput.addEventListener('input', () => loadAdminMessages(searchInput.value));

// Clear all (admin action)
clearAllBtn.addEventListener('click', () => {
  if(!confirm('Clear ALL inbox messages? This cannot be undone.')) return;
  localStorage.removeItem('inbox');
  loadAdminMessages();
});

// initial load
loadAdminMessages();
</script>

</body>
</html>
